import aiofiles
from pyaes import AES
from data.crypto.common import CustomCrypto as CC
from utils.type_helpers import uint8

class Crypt_Nioh2:
    SECRET_KEY = bytearray([
        0x1D, 0x8E, 0xBB, 0x9D, 0x6A, 0x2E, 0x05, 0xBB,
        0x89, 0x6B, 0xF6, 0x9C, 0x03, 0x5A, 0x65, 0x90
    ])
    for i in range(0, len(SECRET_KEY), 4):
        SECRET_KEY[i:i + 4] = SECRET_KEY[i:i + 4][::-1]
    SECRET_KEY = bytes(SECRET_KEY)
    NONCE_COUNTER = bytes([
        0xBB, 0x8B, 0xDD, 0xFB, 0x81, 0x2F, 0x8D, 0x35,
        0x6A, 0xC9, 0x3A, 0xC4, 0x11, 0x2A, 0x7F, 0x82
    ])
    SBOX = [
        0x1C, 0x2F, 0x03, 0x53, 0xA3, 0x01, 0x49, 0xDA, 0xA6, 0xCD, 0xE0, 0x8A, 0x19, 0xA7, 0x04, 0xD4,
        0x06, 0x1A, 0xDA, 0x49, 0x08, 0xE2, 0xF6, 0xB2, 0x9E, 0xE1, 0x22, 0x49, 0xCE, 0x7B, 0x7E, 0x5E,
        0xA0, 0x09, 0x2A, 0x63, 0xAF, 0x49, 0xCE, 0x70, 0x7B, 0x3C, 0x23, 0x80, 0xFA, 0x17, 0x47, 0xF2,
        0x62, 0x62, 0x6C, 0x59, 0x10, 0xCC, 0x29, 0x9C, 0xB5, 0x46, 0x58, 0xC7, 0x44, 0x13, 0xE7, 0x38,
        0xD5, 0xAF, 0x27, 0x83, 0xD4, 0xD5, 0xA0, 0x9E, 0xE3, 0x76, 0x3B, 0x85, 0x04, 0xD9, 0xD6, 0x98,
        0x60, 0x66, 0xD4, 0x78, 0x53, 0xEA, 0xCA, 0x0E, 0x8D, 0x56, 0x53, 0x44, 0xE2, 0xEF, 0xBD, 0xA9,
        0x9B, 0x10, 0x0A, 0xA1, 0x13, 0x93, 0xF0, 0x43, 0x0B, 0x7C, 0x39, 0x8A, 0x47, 0xDF, 0xD3, 0xC5,
        0x0E, 0x34, 0x31, 0xA6, 0xAE, 0x5A, 0xB8, 0xE7, 0xE6, 0x31, 0x43, 0xC0, 0xAA, 0x0F, 0xE0, 0x82,
        0x12, 0x4C, 0xD1, 0xDF, 0x8B, 0xA5, 0xAC, 0x70, 0xC5, 0x3D, 0x1B, 0x8E, 0x93, 0x17, 0x4D, 0x79,
        0x4E, 0xCE, 0x63, 0xC4, 0x33, 0x0E, 0x14, 0x57, 0xF0, 0xD8, 0x19, 0x5B, 0x9B, 0x61, 0x71, 0xF2,
        0x2B, 0x33, 0x7E, 0xFD, 0x2C, 0x0B, 0xB6, 0x23, 0x20, 0xB9, 0xD4, 0x91, 0x19, 0x94, 0x04, 0xA4,
        0x30, 0x13, 0x8A, 0xF1, 0xD0, 0x05, 0xEC, 0x5E, 0xAC, 0x4A, 0xD4, 0xD6, 0xA5, 0x17, 0x7F, 0xF9,
        0xE5, 0xF6, 0x00, 0x29, 0xD7, 0x93, 0x2D, 0x5E, 0x2C, 0xF1, 0x81, 0xA3, 0xB7, 0x63, 0x39, 0x57,
        0xC2, 0x33, 0x87, 0x2D, 0xA8, 0x3F, 0x02, 0xCC, 0x08, 0x67, 0x74, 0x60, 0xD8, 0xF0, 0xDA, 0x67,
        0x40, 0x64, 0x87, 0x55, 0xBB, 0x7F, 0xF2, 0x10, 0xC9, 0x03, 0x14, 0xB5, 0x80, 0x66, 0xCB, 0x91,
        0xF6, 0x1F, 0x79, 0x58, 0x88, 0xBC, 0x95, 0xC2, 0x06, 0x5F, 0xE9, 0x09, 0x32, 0xED, 0x9B, 0x85
    ]
    TE0 = [
        0x381C1C24, 0x5E2F2F71, 0x06030305, 0xA65353F5, 0x5DA3A3FE, 0x02010103, 0x924949DB, 0xAFDADA75, 0x57A6A6F1, 0x81CDCD4C, 0xDBE0E03B, 0x0F8A8A85, 0x3219192B, 0x55A7A7F2, 0x0804040C, 0xB3D4D467,
        0x0C06060A, 0x341A1A2E, 0xAFDADA75, 0x924949DB, 0x10080818, 0xDFE2E23D, 0xF7F6F601, 0x7FB2B2CD, 0x279E9EB9, 0xD9E1E138, 0x44222266, 0x924949DB, 0x87CECE49, 0xF67B7B8D, 0xFC7E7E82, 0xBC5E5EE2,
        0x5BA0A0FB, 0x1209091B, 0x542A2A7E, 0xC66363A5, 0x45AFAFEA, 0x924949DB, 0x87CECE49, 0xE0707090, 0xF67B7B8D, 0x783C3C44, 0x46232365, 0x1B80809B, 0xEFFAFA15, 0x2E171739, 0x8E4747C9, 0xFFF2F20D,
        0xC46262A6, 0xC46262A6, 0xD86C6CB4, 0xB25959EB, 0x20101030, 0x83CCCC4F, 0x5229297B, 0x239C9CBF, 0x71B5B5C4, 0x8C4646CA, 0xB05858E8, 0x95C7C752, 0x884444CC, 0x26131335, 0xD5E7E732, 0x70383848,
        0xB1D5D564, 0x45AFAFEA, 0x4E272769, 0x1D83839E, 0xB3D4D467, 0xB1D5D564, 0x5BA0A0FB, 0x279E9EB9, 0xDDE3E33E, 0xEC76769A, 0x763B3B4D, 0x11858594, 0x0804040C, 0xA9D9D970, 0xB7D6D661, 0x2B9898B3,
        0xC06060A0, 0xCC6666AA, 0xB3D4D467, 0xF0787888, 0xA65353F5, 0xCFEAEA25, 0x8FCACA45, 0x1C0E0E12, 0x018D8D8C, 0xAC5656FA, 0xA65353F5, 0x884444CC, 0xDFE2E23D, 0xC5EFEF2A, 0x61BDBDDC, 0x49A9A9E0,
        0x2D9B9BB6, 0x20101030, 0x140A0A1E, 0x59A1A1F8, 0x26131335, 0x3D9393AE, 0xFBF0F00B, 0x864343C5, 0x160B0B1D, 0xF87C7C84, 0x7239394B, 0x0F8A8A85, 0x8E4747C9, 0xA5DFDF7A, 0xBDD3D36E, 0x91C5C554,
        0x1C0E0E12, 0x6834345C, 0x62313153, 0x57A6A6F1, 0x47AEAEE9, 0xB45A5AEE, 0x6BB8B8D3, 0xD5E7E732, 0xD7E6E631, 0x62313153, 0x864343C5, 0x9BC0C05B, 0x4FAAAAE5, 0x1E0F0F11, 0xDBE0E03B, 0x1F82829D,
        0x24121236, 0x984C4CD4, 0xB9D1D168, 0xA5DFDF7A, 0x0D8B8B86, 0x51A5A5F4, 0x43ACACEF, 0xE0707090, 0x91C5C554, 0x7A3D3D47, 0x361B1B2D, 0x078E8E89, 0x3D9393AE, 0x2E171739, 0x9A4D4DD7, 0xF279798B,
        0x9C4E4ED2, 0x87CECE49, 0xC66363A5, 0x93C4C457, 0x66333355, 0x1C0E0E12, 0x2814143C, 0xAE5757F9, 0xFBF0F00B, 0xABD8D873, 0x3219192B, 0xB65B5BED, 0x2D9B9BB6, 0xC26161A3, 0xE2717193, 0xFFF2F20D,
        0x562B2B7D, 0x66333355, 0xFC7E7E82, 0xE1FDFD1C, 0x582C2C74, 0x160B0B1D, 0x77B6B6C1, 0x46232365, 0x40202060, 0x69B9B9D0, 0xB3D4D467, 0x399191A8, 0x3219192B, 0x339494A7, 0x0804040C, 0x53A4A4F7,
        0x60303050, 0x26131335, 0x0F8A8A85, 0xF9F1F108, 0xBBD0D06B, 0x0A05050F, 0xC3ECEC2F, 0xBC5E5EE2, 0x43ACACEF, 0x944A4ADE, 0xB3D4D467, 0xB7D6D661, 0x51A5A5F4, 0x2E171739, 0xFE7F7F81, 0xE9F9F910,
        0xD1E5E534, 0xF7F6F601, 0x00000000, 0x5229297B, 0xB5D7D762, 0x3D9393AE, 0x5A2D2D77, 0xBC5E5EE2, 0x582C2C74, 0xF9F1F108, 0x19818198, 0x5DA3A3FE, 0x75B7B7C2, 0xC66363A5, 0x7239394B, 0xAE5757F9,
        0x9FC2C25D, 0x66333355, 0x15878792, 0x5A2D2D77, 0x4BA8A8E3, 0x7E3F3F41, 0x04020206, 0x83CCCC4F, 0x10080818, 0xCE6767A9, 0xE874749C, 0xC06060A0, 0xABD8D873, 0xFBF0F00B, 0xAFDADA75, 0xCE6767A9,
        0x804040C0, 0xC86464AC, 0x15878792, 0xAA5555FF, 0x6DBBBBD6, 0xFE7F7F81, 0xFFF2F20D, 0x20101030, 0x89C9C940, 0x06030305, 0x2814143C, 0x71B5B5C4, 0x1B80809B, 0xCC6666AA, 0x8DCBCB46, 0x399191A8,
        0xF7F6F601, 0x3E1F1F21, 0xF279798B, 0xB05858E8, 0x0B888883, 0x63BCBCDF, 0x319595A4, 0x9FC2C25D, 0x0C06060A, 0xBE5F5FE1, 0xC9E9E920, 0x1209091B, 0x64323256, 0xC1EDED2C, 0x2D9B9BB6, 0x11858594
    ]
    TE1 = [
        0x24381C1C, 0x715E2F2F, 0x05060303, 0xF5A65353, 0xFE5DA3A3, 0x03020101, 0xDB924949, 0x75AFDADA, 0xF157A6A6, 0x4C81CDCD, 0x3BDBE0E0, 0x850F8A8A, 0x2B321919, 0xF255A7A7, 0x0C080404, 0x67B3D4D4,
        0x0A0C0606, 0x2E341A1A, 0x75AFDADA, 0xDB924949, 0x18100808, 0x3DDFE2E2, 0x01F7F6F6, 0xCD7FB2B2, 0xB9279E9E, 0x38D9E1E1, 0x66442222, 0xDB924949, 0x4987CECE, 0x8DF67B7B, 0x82FC7E7E, 0xE2BC5E5E,
        0xFB5BA0A0, 0x1B120909, 0x7E542A2A, 0xA5C66363, 0xEA45AFAF, 0xDB924949, 0x4987CECE, 0x90E07070, 0x8DF67B7B, 0x44783C3C, 0x65462323, 0x9B1B8080, 0x15EFFAFA, 0x392E1717, 0xC98E4747, 0x0DFFF2F2,
        0xA6C46262, 0xA6C46262, 0xB4D86C6C, 0xEBB25959, 0x30201010, 0x4F83CCCC, 0x7B522929, 0xBF239C9C, 0xC471B5B5, 0xCA8C4646, 0xE8B05858, 0x5295C7C7, 0xCC884444, 0x35261313, 0x32D5E7E7, 0x48703838,
        0x64B1D5D5, 0xEA45AFAF, 0x694E2727, 0x9E1D8383, 0x67B3D4D4, 0x64B1D5D5, 0xFB5BA0A0, 0xB9279E9E, 0x3EDDE3E3, 0x9AEC7676, 0x4D763B3B, 0x94118585, 0x0C080404, 0x70A9D9D9, 0x61B7D6D6, 0xB32B9898,
        0xA0C06060, 0xAACC6666, 0x67B3D4D4, 0x88F07878, 0xF5A65353, 0x25CFEAEA, 0x458FCACA, 0x121C0E0E, 0x8C018D8D, 0xFAAC5656, 0xF5A65353, 0xCC884444, 0x3DDFE2E2, 0x2AC5EFEF, 0xDC61BDBD, 0xE049A9A9,
        0xB62D9B9B, 0x30201010, 0x1E140A0A, 0xF859A1A1, 0x35261313, 0xAE3D9393, 0x0BFBF0F0, 0xC5864343, 0x1D160B0B, 0x84F87C7C, 0x4B723939, 0x850F8A8A, 0xC98E4747, 0x7AA5DFDF, 0x6EBDD3D3, 0x5491C5C5,
        0x121C0E0E, 0x5C683434, 0x53623131, 0xF157A6A6, 0xE947AEAE, 0xEEB45A5A, 0xD36BB8B8, 0x32D5E7E7, 0x31D7E6E6, 0x53623131, 0xC5864343, 0x5B9BC0C0, 0xE54FAAAA, 0x111E0F0F, 0x3BDBE0E0, 0x9D1F8282,
        0x36241212, 0xD4984C4C, 0x68B9D1D1, 0x7AA5DFDF, 0x860D8B8B, 0xF451A5A5, 0xEF43ACAC, 0x90E07070, 0x5491C5C5, 0x477A3D3D, 0x2D361B1B, 0x89078E8E, 0xAE3D9393, 0x392E1717, 0xD79A4D4D, 0x8BF27979,
        0xD29C4E4E, 0x4987CECE, 0xA5C66363, 0x5793C4C4, 0x55663333, 0x121C0E0E, 0x3C281414, 0xF9AE5757, 0x0BFBF0F0, 0x73ABD8D8, 0x2B321919, 0xEDB65B5B, 0xB62D9B9B, 0xA3C26161, 0x93E27171, 0x0DFFF2F2,
        0x7D562B2B, 0x55663333, 0x82FC7E7E, 0x1CE1FDFD, 0x74582C2C, 0x1D160B0B, 0xC177B6B6, 0x65462323, 0x60402020, 0xD069B9B9, 0x67B3D4D4, 0xA8399191, 0x2B321919, 0xA7339494, 0x0C080404, 0xF753A4A4,
        0x50603030, 0x35261313, 0x850F8A8A, 0x08F9F1F1, 0x6BBBD0D0, 0x0F0A0505, 0x2FC3ECEC, 0xE2BC5E5E, 0xEF43ACAC, 0xDE944A4A, 0x67B3D4D4, 0x61B7D6D6, 0xF451A5A5, 0x392E1717, 0x81FE7F7F, 0x10E9F9F9,
        0x34D1E5E5, 0x01F7F6F6, 0x00000000, 0x7B522929, 0x62B5D7D7, 0xAE3D9393, 0x775A2D2D, 0xE2BC5E5E, 0x74582C2C, 0x08F9F1F1, 0x98198181, 0xFE5DA3A3, 0xC275B7B7, 0xA5C66363, 0x4B723939, 0xF9AE5757,
        0x5D9FC2C2, 0x55663333, 0x92158787, 0x775A2D2D, 0xE34BA8A8, 0x417E3F3F, 0x06040202, 0x4F83CCCC, 0x18100808, 0xA9CE6767, 0x9CE87474, 0xA0C06060, 0x73ABD8D8, 0x0BFBF0F0, 0x75AFDADA, 0xA9CE6767,
        0xC0804040, 0xACC86464, 0x92158787, 0xFFAA5555, 0xD66DBBBB, 0x81FE7F7F, 0x0DFFF2F2, 0x30201010, 0x4089C9C9, 0x05060303, 0x3C281414, 0xC471B5B5, 0x9B1B8080, 0xAACC6666, 0x468DCBCB, 0xA8399191,
        0x01F7F6F6, 0x213E1F1F, 0x8BF27979, 0xE8B05858, 0x830B8888, 0xDF63BCBC, 0xA4319595, 0x5D9FC2C2, 0x0A0C0606, 0xE1BE5F5F, 0x20C9E9E9, 0x1B120909, 0x56643232, 0x2CC1EDED, 0xB62D9B9B, 0x94118585
    ]
    TE2 = [
        0x1C24381C, 0x2F715E2F, 0x03050603, 0x53F5A653, 0xA3FE5DA3, 0x01030201, 0x49DB9249, 0xDA75AFDA, 0xA6F157A6, 0xCD4C81CD, 0xE03BDBE0, 0x8A850F8A, 0x192B3219, 0xA7F255A7, 0x040C0804, 0xD467B3D4,
        0x060A0C06, 0x1A2E341A, 0xDA75AFDA, 0x49DB9249, 0x08181008, 0xE23DDFE2, 0xF601F7F6, 0xB2CD7FB2, 0x9EB9279E, 0xE138D9E1, 0x22664422, 0x49DB9249, 0xCE4987CE, 0x7B8DF67B, 0x7E82FC7E, 0x5EE2BC5E,
        0xA0FB5BA0, 0x091B1209, 0x2A7E542A, 0x63A5C663, 0xAFEA45AF, 0x49DB9249, 0xCE4987CE, 0x7090E070, 0x7B8DF67B, 0x3C44783C, 0x23654623, 0x809B1B80, 0xFA15EFFA, 0x17392E17, 0x47C98E47, 0xF20DFFF2,
        0x62A6C462, 0x62A6C462, 0x6CB4D86C, 0x59EBB259, 0x10302010, 0xCC4F83CC, 0x297B5229, 0x9CBF239C, 0xB5C471B5, 0x46CA8C46, 0x58E8B058, 0xC75295C7, 0x44CC8844, 0x13352613, 0xE732D5E7, 0x38487038,
        0xD564B1D5, 0xAFEA45AF, 0x27694E27, 0x839E1D83, 0xD467B3D4, 0xD564B1D5, 0xA0FB5BA0, 0x9EB9279E, 0xE33EDDE3, 0x769AEC76, 0x3B4D763B, 0x85941185, 0x040C0804, 0xD970A9D9, 0xD661B7D6, 0x98B32B98,
        0x60A0C060, 0x66AACC66, 0xD467B3D4, 0x7888F078, 0x53F5A653, 0xEA25CFEA, 0xCA458FCA, 0x0E121C0E, 0x8D8C018D, 0x56FAAC56, 0x53F5A653, 0x44CC8844, 0xE23DDFE2, 0xEF2AC5EF, 0xBDDC61BD, 0xA9E049A9,
        0x9BB62D9B, 0x10302010, 0x0A1E140A, 0xA1F859A1, 0x13352613, 0x93AE3D93, 0xF00BFBF0, 0x43C58643, 0x0B1D160B, 0x7C84F87C, 0x394B7239, 0x8A850F8A, 0x47C98E47, 0xDF7AA5DF, 0xD36EBDD3, 0xC55491C5,
        0x0E121C0E, 0x345C6834, 0x31536231, 0xA6F157A6, 0xAEE947AE, 0x5AEEB45A, 0xB8D36BB8, 0xE732D5E7, 0xE631D7E6, 0x31536231, 0x43C58643, 0xC05B9BC0, 0xAAE54FAA, 0x0F111E0F, 0xE03BDBE0, 0x829D1F82,
        0x12362412, 0x4CD4984C, 0xD168B9D1, 0xDF7AA5DF, 0x8B860D8B, 0xA5F451A5, 0xACEF43AC, 0x7090E070, 0xC55491C5, 0x3D477A3D, 0x1B2D361B, 0x8E89078E, 0x93AE3D93, 0x17392E17, 0x4DD79A4D, 0x798BF279,
        0x4ED29C4E, 0xCE4987CE, 0x63A5C663, 0xC45793C4, 0x33556633, 0x0E121C0E, 0x143C2814, 0x57F9AE57, 0xF00BFBF0, 0xD873ABD8, 0x192B3219, 0x5BEDB65B, 0x9BB62D9B, 0x61A3C261, 0x7193E271, 0xF20DFFF2,
        0x2B7D562B, 0x33556633, 0x7E82FC7E, 0xFD1CE1FD, 0x2C74582C, 0x0B1D160B, 0xB6C177B6, 0x23654623, 0x20604020, 0xB9D069B9, 0xD467B3D4, 0x91A83991, 0x192B3219, 0x94A73394, 0x040C0804, 0xA4F753A4,
        0x30506030, 0x13352613, 0x8A850F8A, 0xF108F9F1, 0xD06BBBD0, 0x050F0A05, 0xEC2FC3EC, 0x5EE2BC5E, 0xACEF43AC, 0x4ADE944A, 0xD467B3D4, 0xD661B7D6, 0xA5F451A5, 0x17392E17, 0x7F81FE7F, 0xF910E9F9,
        0xE534D1E5, 0xF601F7F6, 0x00000000, 0x297B5229, 0xD762B5D7, 0x93AE3D93, 0x2D775A2D, 0x5EE2BC5E, 0x2C74582C, 0xF108F9F1, 0x81981981, 0xA3FE5DA3, 0xB7C275B7, 0x63A5C663, 0x394B7239, 0x57F9AE57,
        0xC25D9FC2, 0x33556633, 0x87921587, 0x2D775A2D, 0xA8E34BA8, 0x3F417E3F, 0x02060402, 0xCC4F83CC, 0x08181008, 0x67A9CE67, 0x749CE874, 0x60A0C060, 0xD873ABD8, 0xF00BFBF0, 0xDA75AFDA, 0x67A9CE67,
        0x40C08040, 0x64ACC864, 0x87921587, 0x55FFAA55, 0xBBD66DBB, 0x7F81FE7F, 0xF20DFFF2, 0x10302010, 0xC94089C9, 0x03050603, 0x143C2814, 0xB5C471B5, 0x809B1B80, 0x66AACC66, 0xCB468DCB, 0x91A83991,
        0xF601F7F6, 0x1F213E1F, 0x798BF279, 0x58E8B058, 0x88830B88, 0xBCDF63BC, 0x95A43195, 0xC25D9FC2, 0x060A0C06, 0x5FE1BE5F, 0xE920C9E9, 0x091B1209, 0x32566432, 0xED2CC1ED, 0x9BB62D9B, 0x85941185
    ]
    TE3 = [
        0x1C1C2438, 0x2F2F715E, 0x03030506, 0x5353F5A6, 0xA3A3FE5D, 0x01010302, 0x4949DB92, 0xDADA75AF, 0xA6A6F157, 0xCDCD4C81, 0xE0E03BDB, 0x8A8A850F, 0x19192B32, 0xA7A7F255, 0x04040C08, 0xD4D467B3,
        0x06060A0C, 0x1A1A2E34, 0xDADA75AF, 0x4949DB92, 0x08081810, 0xE2E23DDF, 0xF6F601F7, 0xB2B2CD7F, 0x9E9EB927, 0xE1E138D9, 0x22226644, 0x4949DB92, 0xCECE4987, 0x7B7B8DF6, 0x7E7E82FC, 0x5E5EE2BC,
        0xA0A0FB5B, 0x09091B12, 0x2A2A7E54, 0x6363A5C6, 0xAFAFEA45, 0x4949DB92, 0xCECE4987, 0x707090E0, 0x7B7B8DF6, 0x3C3C4478, 0x23236546, 0x80809B1B, 0xFAFA15EF, 0x1717392E, 0x4747C98E, 0xF2F20DFF,
        0x6262A6C4, 0x6262A6C4, 0x6C6CB4D8, 0x5959EBB2, 0x10103020, 0xCCCC4F83, 0x29297B52, 0x9C9CBF23, 0xB5B5C471, 0x4646CA8C, 0x5858E8B0, 0xC7C75295, 0x4444CC88, 0x13133526, 0xE7E732D5, 0x38384870,
        0xD5D564B1, 0xAFAFEA45, 0x2727694E, 0x83839E1D, 0xD4D467B3, 0xD5D564B1, 0xA0A0FB5B, 0x9E9EB927, 0xE3E33EDD, 0x76769AEC, 0x3B3B4D76, 0x85859411, 0x04040C08, 0xD9D970A9, 0xD6D661B7, 0x9898B32B,
        0x6060A0C0, 0x6666AACC, 0xD4D467B3, 0x787888F0, 0x5353F5A6, 0xEAEA25CF, 0xCACA458F, 0x0E0E121C, 0x8D8D8C01, 0x5656FAAC, 0x5353F5A6, 0x4444CC88, 0xE2E23DDF, 0xEFEF2AC5, 0xBDBDDC61, 0xA9A9E049,
        0x9B9BB62D, 0x10103020, 0x0A0A1E14, 0xA1A1F859, 0x13133526, 0x9393AE3D, 0xF0F00BFB, 0x4343C586, 0x0B0B1D16, 0x7C7C84F8, 0x39394B72, 0x8A8A850F, 0x4747C98E, 0xDFDF7AA5, 0xD3D36EBD, 0xC5C55491,
        0x0E0E121C, 0x34345C68, 0x31315362, 0xA6A6F157, 0xAEAEE947, 0x5A5AEEB4, 0xB8B8D36B, 0xE7E732D5, 0xE6E631D7, 0x31315362, 0x4343C586, 0xC0C05B9B, 0xAAAAE54F, 0x0F0F111E, 0xE0E03BDB, 0x82829D1F,
        0x12123624, 0x4C4CD498, 0xD1D168B9, 0xDFDF7AA5, 0x8B8B860D, 0xA5A5F451, 0xACACEF43, 0x707090E0, 0xC5C55491, 0x3D3D477A, 0x1B1B2D36, 0x8E8E8907, 0x9393AE3D, 0x1717392E, 0x4D4DD79A, 0x79798BF2,
        0x4E4ED29C, 0xCECE4987, 0x6363A5C6, 0xC4C45793, 0x33335566, 0x0E0E121C, 0x14143C28, 0x5757F9AE, 0xF0F00BFB, 0xD8D873AB, 0x19192B32, 0x5B5BEDB6, 0x9B9BB62D, 0x6161A3C2, 0x717193E2, 0xF2F20DFF,
        0x2B2B7D56, 0x33335566, 0x7E7E82FC, 0xFDFD1CE1, 0x2C2C7458, 0x0B0B1D16, 0xB6B6C177, 0x23236546, 0x20206040, 0xB9B9D069, 0xD4D467B3, 0x9191A839, 0x19192B32, 0x9494A733, 0x04040C08, 0xA4A4F753,
        0x30305060, 0x13133526, 0x8A8A850F, 0xF1F108F9, 0xD0D06BBB, 0x05050F0A, 0xECEC2FC3, 0x5E5EE2BC, 0xACACEF43, 0x4A4ADE94, 0xD4D467B3, 0xD6D661B7, 0xA5A5F451, 0x1717392E, 0x7F7F81FE, 0xF9F910E9,
        0xE5E534D1, 0xF6F601F7, 0x00000000, 0x29297B52, 0xD7D762B5, 0x9393AE3D, 0x2D2D775A, 0x5E5EE2BC, 0x2C2C7458, 0xF1F108F9, 0x81819819, 0xA3A3FE5D, 0xB7B7C275, 0x6363A5C6, 0x39394B72, 0x5757F9AE,
        0xC2C25D9F, 0x33335566, 0x87879215, 0x2D2D775A, 0xA8A8E34B, 0x3F3F417E, 0x02020604, 0xCCCC4F83, 0x08081810, 0x6767A9CE, 0x74749CE8, 0x6060A0C0, 0xD8D873AB, 0xF0F00BFB, 0xDADA75AF, 0x6767A9CE,
        0x4040C080, 0x6464ACC8, 0x87879215, 0x5555FFAA, 0xBBBBD66D, 0x7F7F81FE, 0xF2F20DFF, 0x10103020, 0xC9C94089, 0x03030506, 0x14143C28, 0xB5B5C471, 0x80809B1B, 0x6666AACC, 0xCBCB468D, 0x9191A839,
        0xF6F601F7, 0x1F1F213E, 0x79798BF2, 0x5858E8B0, 0x8888830B, 0xBCBCDF63, 0x9595A431, 0xC2C25D9F, 0x06060A0C, 0x5F5FE1BE, 0xE9E920C9, 0x09091B12, 0x32325664, 0xEDED2CC1, 0x9B9BB62D, 0x85859411
    ]
    # patch sbox and the transformation tables that depend on it (CTR only needs ECB encrypt)
    # to see how the T-tables are generated, see https://go.dev/src/crypto/internal/fips140/aes/aes_test.go
    _AES = AES.__new__(AES)
    _AES.S = SBOX
    _AES.T1 = TE0
    _AES.T2 = TE1
    _AES.T3 = TE2
    _AES.T4 = TE3
    _AES.__init__(SECRET_KEY)
    class Nioh2(CC):
        class _AES:
            def __init__(self) -> None:
                self.AES = Crypt_Nioh2._AES
                self.counter = bytearray(Crypt_Nioh2.NONCE_COUNTER)
                self.ks = list()

            def custom_aes_ctr(self, chunk: bytearray) -> None:
                size = len(chunk)
                assert size <= CC.CHUNKSIZE
                # fill keystream with enough bytes for the whole chunk
                while len(self.ks) < size:
                    self.ks.extend(self.AES.encrypt(self.counter))
                    # increment counter
                    for i in range(len(self.counter) - 1, -1, -1):
                        b = self.counter[i]
                        b += 1
                        b &= 0xFF
                        self.counter[i] = b
                        if self.counter[i] != 0:
                            break

                for i in range(size):
                    chunk[i] ^= self.ks[i]
                del self.ks[:size]

            def decrypt(self, chunk: bytearray, _: bytearray) -> None:
                self.custom_aes_ctr(chunk)

            def encrypt(self, chunk: bytearray, _: bytearray) -> None:
                self.custom_aes_ctr(chunk)

        def __init__(self, filepath: str) -> None:
            super().__init__(filepath)

        def create_ctx_aes_nioh2(self) -> int:
            cipher = self._AES()
            blocksize = uint8(0, const=True) # streaming mode
            return self._create_ctx(cipher, blocksize)

    @staticmethod
    async def decrypt_file(folderpath: str) -> None:
        files = await CC.obtain_files(folderpath)
        for filepath in files:
            async with Crypt_Nioh2.Nioh2(filepath) as cc:
                aes = cc.create_ctx_aes_nioh2()
                while await cc.read():
                    cc.decrypt(aes)
                    await cc.write()

    @staticmethod
    async def encrypt_file(filepath: str) -> None:
        async with Crypt_Nioh2.Nioh2(filepath) as cc:
            # disable integrity checks
            off1 = 0x7B882 + 0x10
            off2 = 0x7B884 + 0x10
            off3 = 0x7B7E4 + 0x10
            off4 = 0xECF4A + 0x10
            offs = frozenset([off1, off2, off3, off4])
            for off in offs:
                if off >= cc.size:
                    raise CryptoError("Unsupported save!")
                await cc.r_stream.seek(off)
                if await cc.r_stream.read(1) != b"\x01":
                    break
            else:
                for off in offs:
                    await cc.w_stream.seek(off)
                    await cc.w_stream.write(b"\x00")

            # now encrypt
            aes = cc.create_ctx_aes_nioh2()
            while await cc.read():
                cc.encrypt(aes)
                await cc.write()

    @staticmethod
    async def check_enc_ps(filepath: str) -> None:
        async with aiofiles.open(filepath, "rb") as savegame:
            d = await savegame.read(4)
        if d == bytes([0] * 4):
            await Crypt_Nioh2.encrypt_file(filepath)

